apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-backup-s3
  namespace: maratea
spec:
  schedule: "0 2 * * *" # Каждый день в 2:00 UTC
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: postgres-backup
            image: postgres:16-alpine
            env:
            - name: POSTGRES_HOST
              value: postgres
            - name: POSTGRES_PORT
              value: "5432"
            - name: POSTGRES_DB
              value: maratea_platform
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: username
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: password
            - name: S3_ENDPOINT
              valueFrom:
                secretKeyRef:
                  name: s3-backup-secret
                  key: S3_ENDPOINT
            - name: S3_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: s3-backup-secret
                  key: S3_ACCESS_KEY
            - name: S3_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: s3-backup-secret
                  key: S3_SECRET_KEY
            - name: S3_BUCKET
              valueFrom:
                secretKeyRef:
                  name: s3-backup-secret
                  key: S3_BUCKET
            - name: S3_REGION
              valueFrom:
                secretKeyRef:
                  name: s3-backup-secret
                  key: S3_REGION
            command:
            - /bin/sh
            - -c
            - |
              set -e
              # Установка aws-cli
              apk add --no-cache python3 py3-pip
              pip3 install --no-cache-dir --break-system-packages awscli
              
              BACKUP_FILE="postgres-backup-$(date +%Y%m%d-%H%M%S).sql.gz"
              BACKUP_PATH="/tmp/$BACKUP_FILE"
              
              echo "Starting PostgreSQL backup at $(date)"
              PGPASSWORD=$PGPASSWORD pg_dump -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -d $POSTGRES_DB | gzip > $BACKUP_PATH
              
              echo "Backup completed: $BACKUP_FILE"
              echo "Backup size: $(du -h $BACKUP_PATH | cut -f1)"
              
              # Загрузка в S3
              echo "Uploading backup to S3..."
              export AWS_ACCESS_KEY_ID=$S3_ACCESS_KEY
              export AWS_SECRET_ACCESS_KEY=$S3_SECRET_KEY
              export AWS_DEFAULT_REGION=$S3_REGION
              aws --endpoint-url=https://$S3_ENDPOINT s3 cp $BACKUP_PATH s3://$S3_BUCKET/postgres/$BACKUP_FILE
              
              if [ $? -eq 0 ]; then
                echo "Backup uploaded to S3 successfully"
                # Удаляем локальный файл после успешной загрузки
                rm -f $BACKUP_PATH
                
                # Удаляем старые backup'ы из S3 (старше 30 дней)
                echo "Cleaning up old backups from S3 (older than 30 days)..."
                aws --endpoint-url=https://$S3_ENDPOINT s3 ls s3://$S3_BUCKET/postgres/ | while read -r line; do
                  dateStr=$(echo $line | awk '{print $1" "$2}')
                  fileDate=$(date -d "$dateStr" +%s 2>/dev/null || date -j -f "%Y-%m-%d %H:%M:%S" "$dateStr" +%s 2>/dev/null || echo "")
                  if [ -n "$fileDate" ]; then
                    currentDate=$(date +%s)
                    daysDiff=$(( (currentDate - fileDate) / 86400 ))
                    if [ $daysDiff -gt 30 ]; then
                      fileName=$(echo $line | awk '{print $4}')
                      echo "Deleting old backup: $fileName (${daysDiff} days old)"
                      aws --endpoint-url=https://$S3_ENDPOINT s3 rm s3://$S3_BUCKET/postgres/$fileName
                    fi
                  fi
                done
              else
                echo "ERROR: Failed to upload backup to S3"
                exit 1
              fi
              
              echo "Backup process completed at $(date)"
          restartPolicy: OnFailure

